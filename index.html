<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒªï¼ˆå®Œå…¨ç‰ˆï¼‰</title>

  <style>
    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #fff8e1; color: #333; }
    header { padding: 1rem; background: linear-gradient(45deg,#ffd54f,#ffca28); text-align:center; }
    header h1 { margin:0; font-size:1.5rem; color:#5d4037; }
    nav { display: flex; flex-wrap: wrap; justify-content: center; }
    nav button { margin:0.25rem; padding:0.5rem 1rem; flex: 1 1 auto; border:none; border-radius:20px; background:#ffe082; cursor:pointer; }
    nav button:hover { background:#ffd54f; }
    main { padding:1rem; }
    section { display:none; }
    section.active { display:block; }
    .controls { display: flex; flex-wrap: wrap; gap:0.5rem; margin:0.5rem 0; align-items: center; }
    .table-container { overflow-x: auto; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; min-width:600px; }
    th, td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
    th { background:#fff3e0; }
    .status-ok { background:#dcedc8; }
    .status-ng { background:#ffcdd2; }
    button.icon-btn { width:2rem; height:2rem; border-radius:50%; border:none; }
    #quiz-button { position:fixed; bottom:1rem; right:1rem; width:3rem; height:3rem; border:none; border-radius:50%; background:#ffb74d; color:#fff; font-size:1.2rem; }
    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-width: 600px) {
      body { font-size: 14px; }
      header h1 { font-size: 1.2rem; }
      table { min-width: 100%; }
      input[type=number] { width: 3rem; }
      #quiz-button { width: 2.5rem; height: 2.5rem; bottom:0.5rem; right:0.5rem; }
    }
  </style>

  <!-- PWA ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ -->
  <link rel="manifest" href="./manifest.json">
  <!-- ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼ˆAndroid Chrome ç”¨ï¼‰ -->
  <meta name="theme-color" content="#317EFB">
  <!-- iOS ç”¨ãƒ›ãƒ¼ãƒ ç”»é¢å¯¾å¿œ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒª">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body>
  <header>
    <h1>è‹±å˜èªãƒã‚§ãƒƒã‚«ãƒ¼</h1>
    <nav>
      <button id="btn-list">ãƒªã‚¹ãƒˆ</button>
      <button id="btn-quiz">ã‚¯ã‚¤ã‚º</button>
      <button id="btn-chart">é€²æ—</button>
      <button id="btn-reset">ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="btn-download-words">JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button id="btn-export-progress">é€²æ—ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </nav>
  </header>
  <main>
    <!-- ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ -->
    <section id="view-list" class="active">
      <div class="controls">
        <div>å…¨: <span id="total">0</span>ï½œğŸ‘: <span id="ok">0</span>ï½œğŸ‘: <span id="ng">0</span></div>
        <label><input id="filter-ng-only" type="checkbox"> ä¸æ­£è§£ã®ã¿</label>
        <label>ã‚»ã‚¯ã‚·ãƒ§ãƒ³: <select id="section-filter"><option value="">å…¨éƒ¨</option></select></label>
      </div>
      <div class="table-container">
        <table id="word-table">
          <thead>
            <tr><th>No.</th><th>å˜èª</th><th>å“è©</th><th>æ„å‘³</th><th>ğŸ”Š</th><th>ğŸ‘</th><th>ğŸ‘</th><th>â†º</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    <!-- ã‚¯ã‚¤ã‚ºãƒ“ãƒ¥ãƒ¼ -->
    <section id="view-quiz">
      <h2>ã‚¯ã‚¤ã‚º</h2>
      <div class="controls">
        <label><input type="radio" name="quiz-mode" value="en2ja" checked> è‹±â†’æ—¥</label>
        <label><input type="radio" name="quiz-mode" value="ja2en"> æ—¥â†’è‹±</label>
        <label>ç¯„å›²: <input id="quiz-start" type="number" placeholder="é–‹å§‹ID">ï½<input id="quiz-end" type="number" placeholder="çµ‚äº†ID"></label>
        <label><input id="quiz-unchecked" type="checkbox"> æœªãƒã‚§ãƒƒã‚¯ã®ã¿</label>
        <button id="start-quiz" style="margin-left:auto;">é–‹å§‹</button>
      </div>
      <div id="quiz-container" style="margin-top:1rem;"></div>
    </section>
    <!-- é€²æ—ãƒãƒ£ãƒ¼ãƒˆ -->
    <section id="view-chart">
      <h2>é€²æ—</h2>
      <canvas id="progress-chart" width="300" height="150"></canvas>
      <div>ã‚¹ãƒˆãƒªãƒ¼ã‚¯: <span id="streak">0</span> æ—¥</div>
    </section>
  </main>
  <button id="quiz-button">â“</button>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let words = [];
    const STORAGE_KEY = 'vocab-progress', HISTORY_KEY = 'vocab-history';

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    fetch('words.json')
      .then(res => res.json())
      .then(json => { words = json; initApp(); })
      .catch(err => console.error('words.json èª­ã¿è¾¼ã¿å¤±æ•—:', err));

    function initApp() {
      // ãƒŠãƒ“
      document.getElementById('btn-list').onclick = () => show('view-list');
      document.getElementById('btn-quiz').onclick = () => show('view-quiz');
      document.getElementById('btn-chart').onclick = () => show('view-chart');
      document.getElementById('btn-reset').onclick = resetProgress;
      document.getElementById('quiz-button').onclick = () => show('view-quiz');
      document.getElementById('btn-download-words').onclick = downloadWords;
      document.getElementById('btn-export-progress').onclick = exportProgress;
      document.getElementById('start-quiz').onclick = startQuiz;
      // ãƒ•ã‚£ãƒ«ã‚¿
      document.getElementById('filter-ng-only').onchange = renderList;
      document.getElementById('section-filter').onchange = renderList;
      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
      const sections = [...new Set(words.map(w => w.section))].sort();
      const sel = document.getElementById('section-filter');
      sections.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; sel.appendChild(o); });

      renderList(); renderChart();
    }

    function show(id) {
      ['view-list','view-quiz','view-chart'].forEach(v => {
        document.getElementById(v).classList.toggle('active', v === id);
      });
    }

    function loadProgress() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
    function saveProgress(p) { localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }
    function loadHistory() { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '{}'); }
    function saveHistory(h) { localStorage.setItem(HISTORY_KEY, JSON.stringify(h)); }

    function resetProgress() {
      if (confirm('å…¨ã¦ã®é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(HISTORY_KEY);
        renderList(); renderChart();
      }
    }

    function renderList() {
      const prog = loadProgress();
      const tbody = document.querySelector('#word-table tbody'); tbody.innerHTML = '';
      let ok = 0, ng = 0;
      const showNgOnly = document.getElementById('filter-ng-only').checked;
      const selSection = document.getElementById('section-filter').value;
      let list = words;
      if (showNgOnly) list = list.filter(w => prog[w.id] === 'ng');
      if (selSection) list = list.filter(w => w.section === selSection);
      list.forEach(w => {
        const status = prog[w.id]; if (status === 'ok') ok++; if (status === 'ng') ng++;
        const tr = document.createElement('tr');
        if (status === 'ok') tr.classList.add('status-ok');
        if (status === 'ng') tr.classList.add('status-ng');
        tr.innerHTML = `
          <td>${w.id}</td>
          <td>${w.expression}</td>
          <td data-pos>èª­ã¿è¾¼ã¿ä¸­</td>
          <td>${w.translation}</td>
          <td><button onclick="play('${w.expression}')">ğŸ”Š</button></td>
          <td><button onclick="updateStatus(${w.id},'ok')">ğŸ‘</button></td>
          <td><button onclick="updateStatus(${w.id},'ng')">ğŸ‘</button></td>
          <td><button onclick="updateStatus(${w.id},'')">â†º</button></td>
        `;
        tbody.appendChild(tr);
        // POS æ—¥æœ¬èªåŒ–
        const posCell = tr.querySelector('[data-pos]');
        if (w.pos) {
          posCell.textContent = w.pos + (w.expression.includes(' ') ? 'ãƒ»ç†Ÿèª' : '');
        } else {
          fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w.expression}`)
            .then(r => r.json())
            .then(data => {
              const part = data[0]?.meanings?.[0]?.partOfSpeech || 'noun';
              const map = {
                noun:'åè©',verb:'å‹•è©',adjective:'å½¢å®¹è©',adverb:'å‰¯è©',
                pronoun:'ä»£åè©',preposition:'å‰ç½®è©',conjunction:'æ¥ç¶šè©',interjection:'æ„Ÿå‹•è©'
              };
              const jp = map[part] || 'åè©';
              posCell.textContent = jp + (w.expression.includes(' ') ? 'ãƒ»ç†Ÿèª' : '');
            })
            .catch(() => { posCell.textContent = 'åè©' + (w.expression.includes(' ') ? 'ãƒ»ç†Ÿèª' : ''); });
        }
      });
      document.getElementById('total').textContent = list.length;
      document.getElementById('ok').textContent = ok;
      document.getElementById('ng').textContent = ng;
      updateHistory(ok);
    }

    function updateStatus(id, status) { const p = loadProgress(); if (status) p[id]=status; else delete p[id]; saveProgress(p); renderList(); }
    function play(text) { const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; speechSynthesis.speak(u); }

    let quizWords = [], idx = 0;
    function startQuiz() {
      const prog = loadProgress();
      const startId = parseInt(document.getElementById('quiz-start').value)||1;
      const endId   = parseInt(document.getElementById('quiz-end').value)||words.length;
      const onlyUncheck = document.getElementById('quiz-unchecked')?.checked;
      quizWords = words.filter(w=>w.id>=startId&&w.id<=endId&&(onlyUncheck?!prog[w.id]:prog[w.id]==='ng'));
      quizWords.sort(()=>Math.random()-0.5); idx=0; nextQuiz();
    }

    function nextQuiz() {
      const ctr = document.getElementById('quiz-container'); ctr.innerHTML='';
      if(idx>=quizWords.length){ctr.textContent='çµ‚äº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼';return;}
      const w = quizWords[idx++];
      const mode = document.querySelector('input[name="quiz-mode"]:checked').value;
      let question, correct, opts;
      if(mode==='en2ja'){
        question = `${w.expression} ã®æ„å‘³ã¯ï¼Ÿ`;
        correct = w.translation;
        opts=[correct]; while(opts.length<4){const c=words[Math.floor(Math.random()*words.length)].translation; if(!opts.includes(c))opts.push(c);}      
      } else {
        question = `${w.translation} ã«å½“ã¦ã¯ã¾ã‚‹è‹±å˜èªã¯ï¼Ÿ`;
        correct = w.expression;
        opts=[correct]; while(opts.length<4){const c=words[Math.floor(Math.random()*words.length)].expression; if(!opts.includes(c))opts.push(c);}      
      }
      opts.sort(()=>Math.random()-0.5);
      const div=document.createElement('div'); div.innerHTML=`<p>${question}</p>`;
      opts.forEach(o=>{const b=document.createElement('button');b.textContent=o;b.onclick=()=>{if(o===correct){updateStatus(w.id,'ok');alert('æ­£è§£ï¼ã§ããŸï¼');}else{updateStatus(w.id,'ng');alert('ä¸æ­£è§£â€¦ æ­£è§£:'+correct);}nextQuiz();};div.appendChild(b);});ctr.appendChild(div);
    }

    function downloadWords(){const a=document.createElement('a');a.href='words.json';a.download='words.json';a.click();}
    function exportProgress(){const data={progress:loadProgress(),history:loadHistory()};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`export_${new Date().toISOString().slice(0,10)}.json`;a.click();URL.revokeObjectURL(url);}    
    function updateHistory(okCount){const h=loadHistory();const today=new Date().toISOString().slice(0,10);h[today]=okCount;saveHistory(h);}    
    let chart;    
    function renderChart(){const h=loadHistory();const dates=Object.keys(h).sort();const okData=dates.map(d=>h[d]);const ngData=dates.map(d=>words.length-h[d]);const ctx=document.getElementById('progress-chart').getContext('2d');if(chart)chart.destroy();chart=new Chart(ctx,{type:'line',data:{labels:dates,datasets:[{label:'ğŸ‘',data:okData},{label:'ğŸ‘',data:ngData}]}});let streak=0;for(let i=dates.length-1;i>=0;i--){if(okData[i]>0)streak++;else break;}document.getElementById('streak').textContent=streak;}
  </script>
  <!-- ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ² -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./service-worker.js')
          .then(function(reg) { console.log('ServiceWorker registered:', reg.scope); })
          .catch(function(err) { console.error('ServiceWorker registration failed:', err); });
      });
    }
  </script>
</body>
</html>
